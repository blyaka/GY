{% extends "_base.html" %}
{% load static %}

{% block title %}Магазин{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'css/shop.css' %}">
    <link rel="stylesheet" href="{% static 'css/lk.css' %}">
{% endblock %}

{% block content %}
    <div class="status-bar" role="navigation" aria-label="Статус-бар">
        <div class="sb-inner">
            <img class="sb-logo" src="{% static 'images/GY.svg' %}" alt="GY">
            <span class="sb-dot" aria-hidden="true"></span>
            <a class="sb-link" href="{% url 'shop' %}">ИЗБРАННОЕ</a>
        </div>
    </div>

    <main>

        <div class="lk-section-name">
            <img src="static/icons/user.svg" alt="">
            <p>ИЗБРАННОЕ</p>
        </div>

        <section class="catalog">

            <div class="catalog-grid">
                {% for p in items %}
                    <a class="p-card" href="{% url 'product_detail' p.pk %}" data-pid="{{ p.id }}">
                        <div class="p-media" aria-label="Изображение товара">
                            <button class="p-flag-btn" type="button" aria-label="В избранное" aria-pressed="false">
                                <svg width="30" height="35" viewBox="0 0 18 22" aria-hidden="true">
                                    <path d="M3 2.5H15a1 1 0 0 1 1 1V20.5L9 16.5l-7 4V3.5a1 1 0 0 1 1-1Z" fill="none"
                                        stroke="#fff" stroke-width="2" stroke-linejoin="round" />
                                </svg>
                            </button>
                            <button class="p-eye-btn" type="button" aria-label="Быстрый просмотр">
                                <img src="{% static 'icons/eye.svg' %}" alt="" width="18" height="18">
                            </button>
                            {% if p.thumb_id %}
                                {% for im in p.images.all %}
                                    {% if im.id == p.thumb_id %}
                                        <img src="{{ im.image.url }}" alt="{{ p.name }}">
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                <img src="{% static 'images/no-photo.png' %}" alt="Нет фото">
                            {% endif %}
                        </div>
                        <div class="p-info">
                            <div class="p-title">{{ p.name }}</div>
                            <div class="p-meta">
                                <span class="p-price">{{ p.formatted_price }} ₽</span>
                                <span class="p-art">АРТ. {{ p.article }}</span>
                            </div>
                        </div>
                    </a>
                {% empty %}
                    <p>Нет товаров</p>
                {% endfor %}
            </div>

        </section>

        <!-- PAGINATION -->
        {% if is_paginated %}
        <nav class="pager" role="navigation" aria-label="Пагинация">
            {% if page_obj.has_previous %}
                <a class="pg-btn pg-prev" href="?page={{ page_obj.previous_page_number }}">&laquo;</a>
            {% endif %}

            <ul class="pg-list">
                {% for num in paginator.page_range %}
                    {% if num == page_obj.number %}
                        <li><span class="pg-link is-current">{{ num }}</span></li>
                    {% else %}
                        <li><a class="pg-link" href="?page={{ num }}">{{ num }}</a></li>
                    {% endif %}
                {% endfor %}
            </ul>

            {% if page_obj.has_next %}
                <a class="pg-btn pg-next" href="?page={{ page_obj.next_page_number }}">&raquo;</a>
            {% endif %}
        </nav>
        {% endif %}


        <script>
            (() => {
                let qv, qvPhoto, qvTitle, qvPrice, qvArt, qvBookmark, currentCard = null;

                function cacheQv() {
                    if (qv) return;
                    qv = document.getElementById('qv');
                    qvPhoto = document.getElementById('qvPhoto');
                    qvTitle = document.getElementById('qvTitle');
                    qvPrice = document.getElementById('qvPrice');
                    qvArt = document.getElementById('qvArt');
                    qvBookmark = document.getElementById('qvBookmark');

                    qv?.addEventListener('click', e => { if (e.target.hasAttribute('data-qv-close')) closeQuickView(); });
                    qvBookmark?.addEventListener('click', (e) => {
                        e.preventDefault();
                        const on = !qvBookmark.classList.contains('active');
                        qvBookmark.classList.toggle('active', on);
                        qvBookmark.setAttribute('aria-pressed', on);
                        const flag = currentCard?.querySelector('.p-flag-btn');
                        if (flag) { flag.classList.toggle('active', on); flag.setAttribute('aria-pressed', on); }
                    });
                }

                function syncBookmarkFromCard(card) {
                    const flag = card?.querySelector('.p-flag-btn');
                    const on = !!flag && flag.classList.contains('active');
                    qvBookmark?.classList.toggle('active', on);
                    qvBookmark?.setAttribute('aria-pressed', on);
                }

                function openQuickView(card) {
                    cacheQv();
                    currentCard = card;
                    const title = card.querySelector('.p-title')?.textContent?.trim() || 'Товар';
                    const price = card.querySelector('.p-price')?.innerHTML || '';
                    const art = card.querySelector('.p-art')?.textContent?.trim() || '';
                    const img = card.dataset.img || card.querySelector('.p-media img')?.getAttribute('src');

                    qvTitle.textContent = title;
                    qvPrice.innerHTML = price;
                    qvArt.textContent = art;
                    qvPhoto.style.background = img ? `url('${img}') center/cover no-repeat` : '#e2e2e2';

                    syncBookmarkFromCard(card);

                    qv.classList.add('open');
                    document.body.style.overflow = 'hidden';
                }
                function closeQuickView() {
                    qv?.classList.remove('open');
                    document.body.style.overflow = '';
                    currentCard = null;
                }

                document.addEventListener('click', (e) => {
                    const eye = e.target.closest('.p-eye-btn');
                    if (!eye) return;
                    e.preventDefault(); e.stopPropagation();
                    const card = eye.closest('.p-card');
                    openQuickView(card);
                });

                document.addEventListener('click', (e) => {
                    const flag = e.target.closest('.p-flag-btn');
                    if (!flag) return;
                    e.preventDefault(); e.stopPropagation();
                    const on = !flag.classList.contains('active');
                    flag.classList.toggle('active', on);
                    flag.setAttribute('aria-pressed', on);
                    if (currentCard && flag.closest('.p-card') === currentCard) {
                        cacheQv();
                        qvBookmark.classList.toggle('active', on);
                        qvBookmark.setAttribute('aria-pressed', on);
                    }
                });

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && qv?.classList.contains('open')) closeQuickView();
                });
            })();
        </script>


        <!-- MODAL QUICK VIEW MODAL -->
        <div class="qv" id="qv" aria-hidden="true">
            <div class="qv-overlay" data-qv-close></div>

            <div class="qv-panel" role="dialog" aria-modal="true" aria-label="Быстрый просмотр">
                <button class="qv-x" type="button" aria-label="Закрыть" data-qv-close>×</button>

                <div class="qv-left">
                    <div class="qv-photo" id="qvPhoto" role="img" aria-label="Фото товара"></div>
                </div>

                <div class="qv-right">
                    <div class="qv-top">
                        <h3 class="qv-title" id="qvTitle"></h3>
                        <button class="qv-bookmark" type="button" aria-label="В избранное" id="qvBookmark"
                            aria-pressed="false">
                            <svg width="22" height="26" viewBox="0 0 18 22" aria-hidden="true" focusable="false">
                                <path d="M3 2.5H15a1 1 0 0 1 1 1V20.5L9 16.5l-7 4V3.5a1 1 0 0 1 1-1Z" fill="none"
                                    stroke="#111" stroke-width="2" stroke-linejoin="round" />
                            </svg>
                        </button>
                    </div>

                    <div class="qv-price" id="qvPrice"></div>
                    <div class="qv-art" id="qvArt"></div>

                    <div class="qv-opts">
                        <div class="qv-row"><span class="qv-label">Цвета:</span> <div id="qvColors" class="qv-colors"></div></div>
                        <div class="qv-row"><span class="qv-label">Размеры:</span> <div id="qvSizes" class="qv-sizes"></div></div>
                        <div class="qv-row"><span class="qv-label">Состав:</span> <div id="qvFabrics" class="qv-fabrics"></div></div>
                    </div>

                </div>
            </div>
        </div>

    </main>

{% endblock content %}