{% extends "_base.html" %}
{% load static %}
{% load site_settings %}
{% get_site_contacts as s %}

{% block title %}Магазин{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'css/shop.css' %}">
{% endblock %}

{% block content %}
    <div class="status-bar" role="navigation" aria-label="Статус-бар">
        <div class="sb-inner">
            <img class="sb-logo" src="{% static 'images/GY.svg' %}" alt="GY">
            <span class="sb-dot" aria-hidden="true"></span>
            <a class="sb-link" href="{% url 'shop' %}">МАГАЗИН</a>
        </div>
    </div>


    <main>

        <div class="serch-container">
            <h2 class="shop-title">МАГАЗИН</h2>

            <form class="shop-search" role="search" method="get">
                <button class="shop-search-btn" aria-label="Поиск">
                    <img src="{% static 'icons/search.svg' %}" alt="">
                </button>
                <input class="shop-search-input" type="search" name="q" value="{{ q }}" placeholder="Поиск по товарам">
            </form>
        </div>


        <!-- FILTERS BAR -->
        <div class="filters-bar" role="region" aria-label="Фильтры каталога">
            <div class="fb-top">
                <button class="fb-menu" aria-label="Открыть панель фильтров">
                    <svg width="30" height="30" viewBox="0 0 18 18" aria-hidden="true" focusable="false">
                        <rect width="18" height="18" rx="1" fill="#111" />
                        <path d="M3 5.5H15" stroke="#fff" stroke-width="1.2" stroke-linecap="round" />
                        <path d="M5 9H13" stroke="#fff" stroke-width="1.2" stroke-linecap="round" />
                        <path d="M6.5 12.5H11.5" stroke="#fff" stroke-width="1.2" stroke-linecap="round" />
                    </svg>


                </button>
            </div>

            <div class="fb-row">
                <div class="fb-dd" data-dd="category">
                    <button class="fb-item" type="button">КАТЕГОРИЯ ТОВАРА
                        <svg class="chev" width="10" height="16" viewBox="0 0 8 12">
                            <path d="M1 1 L7 6 L1 11" fill="none" stroke="currentColor" stroke-width="1.4"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </button>
                        <div class="fb-popover w260">
                            <ul class="dd-list">
                                {% for cat in categories %}
                                <li>
                                    <button type="button" class="dd-category"
                                            data-category="{{ cat.id }}"
                                            {% if selected.category|add:'' == cat.id|add:'' %}aria-current="true"{% endif %}>
                                    {{ cat.name }}
                                    </button>
                                </li>
                                {% endfor %}
                                <li class="dd-all"><button type="button" class="dd-category-clear">Показать все</button></li>
                            </ul>
                        </div>
                </div>

                <!-- РАЗМЕР -->
                <div class="fb-dd" data-dd="size">
                    <button class="fb-item" type="button">РАЗМЕР ОДЕЖДЫ
                        <svg class="chev" width="10" height="16" viewBox="0 0 8 12">
                            <path d="M1 1 L7 6 L1 11" fill="none" stroke="currentColor" stroke-width="1.4"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </button>
                    <div class="fb-popover w220">
                        <div class="dd-sizes">
                            {% for sz in sizes %}
                                <button class="sz" data-size="{{ sz.id }}">{{ sz.name }}</button>
                            {% endfor %}
                        </div>
                        <a href="#" class="dd-link muted">РАЗМЕРНАЯ СЕТКА</a>
                    </div>
                </div>

                <!-- ЦЕНА -->
                <div class="fb-dd" data-dd="price">
                    <button class="fb-item" type="button">ЦЕНА
                        <svg class="chev" width="10" height="16" viewBox="0 0 8 12">
                            <path d="M1 1 L7 6 L1 11" fill="none" stroke="currentColor" stroke-width="1.4"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </button>
                    <div class="fb-popover w320">
                        <div class="dd-price">
                            <div class="row">
                                <input type="number" class="price-min" value="0" min="0" max="100000" step="100">
                                <input type="number" class="price-max" value="100000" min="0" max="100000" step="100">
                            </div>
                            <div class="range-wrap" data-min="0" data-max="100000">
                                <input type="range" class="range-min" min="0" max="100000" value="0" step="100">
                                <input type="range" class="range-max" min="0" max="100000" value="100000" step="100">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ЦВЕТ -->
                <div class="fb-dd" data-dd="color">
                    <button class="fb-item" type="button">ЦВЕТ
                        <svg class="chev" width="10" height="16" viewBox="0 0 8 12">
                            <path d="M1 1 L7 6 L1 11" fill="none" stroke="currentColor" stroke-width="1.4"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </button>
                    <div class="fb-popover w160">
                        <div class="dd-colors">
                            {% for clr in colors %}
                                <button class="dot" style="--c:{{ clr.hex_code }}" title="{{ clr.name }}" data-color="{{ clr.id }}"></button>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                </nav>

                <div class="fb-sort">
                    <div class="fb-dd" data-dd="sort">
                        <button class="fb-item fb-sortby" type="button">ПО СТОИМОСТИ
                            <svg class="chev" width="10" height="16" viewBox="0 0 8 12">
                                <path d="M1 1 L7 6 L1 11" fill="none" stroke="currentColor" stroke-width="1.4"
                                    stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </button>
                        <div class="fb-popover w260">
                            <ul class="dd-list">
                                <li><button class="dd-option" data-sort="asc">Цена по возрастанию</button></li>
                                <li><button class="dd-option" data-sort="desc">Цена по убыванию</button></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>





        <section class="catalog">

            <div class="catalog-grid">
                {% for p in items %}
                    <a class="p-card" href="{% url 'product_detail' p.pk %}" data-pid="{{ p.id }}">
                        <div class="p-media" aria-label="Изображение товара">
                            <button class="p-flag-btn" type="button" aria-label="В избранное" aria-pressed="false">
                                <svg width="30" height="35" viewBox="0 0 18 22" aria-hidden="true">
                                    <path d="M3 2.5H15a1 1 0 0 1 1 1V20.5L9 16.5l-7 4V3.5a1 1 0 0 1 1-1Z" fill="none"
                                        stroke="#fff" stroke-width="2" stroke-linejoin="round" />
                                </svg>
                            </button>
                            <button class="p-eye-btn" type="button" aria-label="Быстрый просмотр">
                                <img src="{% static 'icons/eye.svg' %}" alt="" width="18" height="18">
                            </button>
                            {% if p.thumb_id %}
                                {% for im in p.images.all %}
                                    {% if im.id == p.thumb_id %}
                                        <img src="{{ im.image.url }}" alt="{{ p.name }}">
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                <img src="{% static 'images/no-photo.png' %}" alt="Нет фото">
                            {% endif %}
                        </div>
                        <div class="p-info">
                            <div class="p-title">{{ p.name }}</div>
                            <div class="p-meta">
                                <span class="p-price">{{ p.formatted_price }} ₽</span>
                                <span class="p-art">АРТ. {{ p.article }}</span>
                            </div>
                        </div>
                    </a>
                {% empty %}
                    <p>Нет товаров</p>
                {% endfor %}
            </div>

        </section>

        <!-- PAGINATION -->
        {% if is_paginated %}
        <nav class="pager" role="navigation" aria-label="Пагинация">

            {# Кнопка "назад" #}
            {% if page_obj.has_previous %}
                <a class="pg-btn pg-prev"
                href="?page={{ page_obj.previous_page_number }}{% if querystring %}&{{ querystring }}{% endif %}">
                    <img src="{% static 'icons/arrow.svg' %}" alt="">
                </a>
            {% else %}
                <button class="pg-btn pg-prev" aria-disabled="true" disabled>
                    <img src="{% static 'icons/arrow.svg' %}" alt="">
                </button>
            {% endif %}

            <ul class="pg-list">
                {% for num in paginator.page_range %}
                    {% if num == page_obj.number %}
                        <li><span class="pg-link is-current">{{ num }}</span></li>
                    {% else %}
                        <li>
                            <a class="pg-link"
                            href="?page={{ num }}{% if querystring %}&{{ querystring }}{% endif %}">{{ num }}</a>
                        </li>
                    {% endif %}
                {% endfor %}
            </ul>

            {# Кнопка "вперёд" #}
            {% if page_obj.has_next %}
                <a class="pg-btn pg-next"
                href="?page={{ page_obj.next_page_number }}{% if querystring %}&{{ querystring }}{% endif %}">
                    <img src="{% static 'icons/arrow.svg' %}" alt="">
                </a>
            {% else %}
                <button class="pg-btn pg-next" aria-disabled="true" disabled>
                    <img src="{% static 'icons/arrow.svg' %}" alt="">
                </button>
            {% endif %}

        </nav>
        {% endif %}

        <!-- MODAL QUICK VIEW MODAL -->
        <div class="qv" id="qv" aria-hidden="true">
            <div class="qv-overlay" data-qv-close></div>

            <div class="qv-panel" role="dialog" aria-modal="true" aria-label="Быстрый просмотр">
                <button class="qv-x" type="button" aria-label="Закрыть" data-qv-close>×</button>

                <div class="qv-left">
                    <div class="qv-photo" id="qvPhoto" role="img" aria-label="Фото товара"></div>
                </div>

                <div class="qv-right">
                    <div class="qv-top">
                        <h3 class="qv-title" id="qvTitle"></h3>
                        <button class="qv-bookmark" type="button" aria-label="В избранное" id="qvBookmark"
                            aria-pressed="false">
                            <svg width="22" height="26" viewBox="0 0 18 22" aria-hidden="true" focusable="false">
                                <path d="M3 2.5H15a1 1 0 0 1 1 1V20.5L9 16.5l-7 4V3.5a1 1 0 0 1 1-1Z" fill="none"
                                    stroke="#111" stroke-width="2" stroke-linejoin="round" />
                            </svg>
                        </button>
                    </div>

                    <div class="qv-price" id="qvPrice"></div>
                    <div class="qv-art" id="qvArt"></div>

                    <div class="qv-opts">
                        <div class="qv-row"><span class="qv-label">Цвета:</span> <div id="qvColors" class="qv-colors"></div></div>
                        <div class="qv-row"><span class="qv-label">Размеры:</span> <div id="qvSizes" class="qv-sizes"></div></div>
                        <div class="qv-row"><span class="qv-label">Состав:</span> <div id="qvFabrics" class="qv-fabrics"></div></div>
                    </div>

                </div>
            </div>
        </div>


    </main>

{{ fav_ids|json_script:"fav-ids-json" }}

<script>
(() => {
  // ===== утилиты
  const $  = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
  const fmt = new Intl.NumberFormat('ru-RU');

  // ===== fav ids из сервера
  const favSet = new Set(JSON.parse(document.getElementById('fav-ids-json')?.textContent || '[]'));

  // CSRF
  function getCookie(name){
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }
  const csrftoken = getCookie('csrftoken');

  async function toggleFavorite(pid){
    const res = await fetch("{% url 'toggle_fv' %}", {
      method: 'POST',
      headers: {'Content-Type':'application/json','X-CSRFToken': csrftoken},
      body: JSON.stringify({product_id: Number(pid)})
    });
    if(!res.ok) throw new Error('toggle failed');
    return res.json();
  }

  // ===== POPover’ы (твои фильтры) — оставил без изменений
  const dds = $$('.fb-dd');
  dds.forEach(dd => {
    const btn = dd.querySelector('.fb-item');
    btn?.addEventListener('click', e => {
      e.stopPropagation();
      const opened = dd.classList.contains('open');
      dds.forEach(x => x.classList.remove('open'));
      if (!opened) dd.classList.add('open');
    });
  });
  document.addEventListener('click', () => dds.forEach(x => x.classList.remove('open')));
  document.addEventListener('keydown', e => { if (e.key === 'Escape') dds.forEach(x => x.classList.remove('open')); });

  const bar   = $('.filters-bar');
  const btnM  = bar?.querySelector('.fb-menu');
  const row   = bar?.querySelector('.fb-row');

  const ddCat   = $('.fb-dd[data-dd="category"]');
  const ddSize  = $('.fb-dd[data-dd="size"]');
  const ddColor = $('.fb-dd[data-dd="color"]');
  const ddPrice = $('.fb-dd[data-dd="price"]');
  const ddSort  = $('.fb-dd[data-dd="sort"]');

  const btnCats     = $$('.dd-category');
  const btnCatClear = $('.dd-category-clear');
  const sizeBtns    = $$('.dd-sizes .sz');
  const colorBtns   = $$('.dd-colors .dot');

  const rMin = ddPrice?.querySelector('.range-min');
  const rMax = ddPrice?.querySelector('.range-max');
  const iMin = ddPrice?.querySelector('.price-min');
  const iMax = ddPrice?.querySelector('.price-max');
  const wrap = ddPrice?.querySelector('.range-wrap');
  const minGap = 100;

  if (bar && btnM && row) {
    const closePopovers = () => bar.querySelectorAll('.fb-dd.open').forEach(x => x.classList.remove('open'));
    const collapse = () => {
      closePopovers();
      const h = row.scrollHeight;
      row.style.height = h + 'px';
      bar.classList.add('is-collapsing');
      requestAnimationFrame(() => {
        row.style.opacity = '0';
        row.style.height = '0px';
      });
      row.addEventListener('transitionend', function onEnd(e) {
        if (e.propertyName !== 'height') return;
        row.removeEventListener('transitionend', onEnd);
        row.style.display = 'none';
        row.style.opacity = '';
        row.style.height = '';
        bar.classList.remove('is-collapsing');
        bar.classList.add('is-collapsed');
        btnM.setAttribute('aria-expanded', 'false');
      });
    };
    const expand = () => {
      row.style.display = '';
      row.style.opacity = '0';
      row.style.height = '0px';
      const h = row.scrollHeight;
      bar.classList.add('is-expanding');
      requestAnimationFrame(() => {
        row.style.opacity = '1';
        row.style.height = h + 'px';
      });
      row.addEventListener('transitionend', function onEnd(e) {
        if (e.propertyName !== 'height') return;
        row.removeEventListener('transitionend', onEnd);
        row.style.opacity = '';
        row.style.height = '';
        bar.classList.remove('is-expanding');
        bar.classList.remove('is-collapsed');
        btnM.setAttribute('aria-expanded', 'true');
      });
    };
    btnM.addEventListener('click', e => {
      e.preventDefault();
      if (bar.classList.contains('is-collapsed')) expand(); else collapse();
    });
    window.addEventListener('resize', () => {
      if (!bar.classList.contains('is-collapsed') && row.style.height) {
        row.style.height = row.scrollHeight + 'px';
      }
    });
  }

  const setActiveBadge = (dd, on) => dd?.querySelector('.fb-item')?.classList.toggle('is-active', !!on);
  function updateBadges() {
    const catOn = !!$('.dd-category[aria-current="true"]');
    const szOn  = !!$('.dd-sizes .sz.active');
    const clrOn = !!$('.dd-colors .dot.active');
    let priceOn = false;
    if (rMin && rMax) priceOn = (+rMin.value > +rMin.min) || (+rMax.value < +rMax.max);
    setActiveBadge(ddCat,   catOn);
    setActiveBadge(ddSize,  szOn);
    setActiveBadge(ddColor, clrOn);
    setActiveBadge(ddPrice, priceOn);
  }

  const params = new URLSearchParams(location.search);
  const DEF_MIN = (rMin?.min ? +rMin.min : null) ?? 0;
  const DEF_MAX = (rMax?.max ? +rMax.max : null) ?? 100000;

  const curCat = params.get('category');
  btnCats.forEach(b => {
    if (b.dataset.category === curCat) {
      b.setAttribute('aria-current','true');
      ddCat?.setAttribute('data-selected','1');
    }
  });
  params.getAll('size').forEach(v => sizeBtns.forEach(b => b.dataset.size === v && b.classList.add('active')));
  params.getAll('color').forEach(v => colorBtns.forEach(b => b.dataset.color === v && b.classList.add('active')));
  if (rMin && rMax && iMin && iMax) {
    const curMin = +(params.get('price_min') ?? DEF_MIN);
    const curMax = +(params.get('price_max') ?? DEF_MAX);
    rMin.value = iMin.value = curMin;
    rMax.value = iMax.value = curMax;
    paintRange();
  }
  updateBadges();

  function applyFilters(extra={}) {
    const p = new URLSearchParams();
    const q = $('.shop-search-input')?.value?.trim();
    if (q) p.set('q', q);
    const activeCat = $('.dd-category[aria-current="true"]')?.dataset.category;
    if (activeCat) p.set('category', activeCat);
    $$('.dd-sizes .sz.active').forEach(b => p.append('size', b.dataset.size));
    $$('.dd-colors .dot.active').forEach(b => p.append('color', b.dataset.color));
    if (rMin && rMax) {
      const a = +rMin.value, b = +rMax.value;
      if (a !== DEF_MIN) p.set('price_min', a);
      if (b !== DEF_MAX) p.set('price_max', b);
    }
    const order = params.get('order');
    if (order && !extra.order) p.set('order', order);
    if (extra.order) p.set('order', extra.order);
    const qs = p.toString();
    location.search = qs ? `?${qs}` : '';
  }

  $('.shop-search')?.addEventListener('submit', e => { e.preventDefault(); applyFilters(); });
  btnCats.forEach(b => b.addEventListener('click', e => {
    e.preventDefault(); e.stopImmediatePropagation();
    $$('.dd-category[aria-current="true"]').forEach(x => x.removeAttribute('aria-current'));
    b.setAttribute('aria-current', 'true');
    ddCat?.setAttribute('data-selected','1');
    updateBadges();
    applyFilters();
  }));
  btnCatClear?.addEventListener('click', e => {
    e.preventDefault(); e.stopImmediatePropagation();
    $$('.dd-category[aria-current="true"]').forEach(x => x.removeAttribute('aria-current'));
    ddCat?.removeAttribute('data-selected');
    updateBadges();
    applyFilters();
  });
  colorBtns.forEach(b => b.addEventListener('click', e => {
    e.preventDefault(); e.stopImmediatePropagation();
    b.classList.toggle('active');
    updateBadges();
    applyFilters();
  }));
  sizeBtns.forEach(b => b.addEventListener('click', e => {
    e.preventDefault(); e.stopImmediatePropagation();
    b.classList.toggle('active');
    updateBadges();
    applyFilters();
  }));

  function paintRange() {
    if (!wrap || !rMin || !rMax) return;
    const min = +rMin.min || DEF_MIN, max = +rMax.max || DEF_MAX;
    const a = (+rMin.value - min) / (max - min) * 100;
    const b = (+rMax.value - min) / (max - min) * 100;
    wrap.style.background =
      `linear-gradient(to right,#d9d9d9 ${a}% ,#111 ${a}%, #111 ${b}%, #d9d9d9 ${b}%)`;
  }
  function clampFromRange(changed) {
    if (!rMin || !rMax || !iMin || !iMax) return;
    let a = +rMin.value, b = +rMax.value;
    if (b - a < minGap) {
      if (changed === rMin) a = b - minGap; else b = a + minGap;
      rMin.value = a; rMax.value = b;
    }
    iMin.value = rMin.value; iMax.value = rMax.value;
    paintRange(); updateBadges();
  }
  function clampFromInput() {
    if (!rMin || !rMax || !iMin || !iMax) return;
    let a = Math.max(+iMin.min || DEF_MIN, +iMin.value || DEF_MIN);
    let b = Math.min(+iMax.max || DEF_MAX, +iMax.value || DEF_MAX);
    if (b - a < minGap) b = a + minGap;
    rMin.value = a; rMax.value = b;
    iMin.value = a; iMax.value = b;
    paintRange(); updateBadges();
  }
  rMin?.addEventListener('input', () => clampFromRange(rMin));
  rMax?.addEventListener('input', () => clampFromRange(rMax));
  iMin?.addEventListener('change', clampFromInput);
  iMax?.addEventListener('change', clampFromInput);

  $('.fb-clear')?.addEventListener('click', () => {
    $$('.dd-category[aria-current="true"]').forEach(x => x.removeAttribute('aria-current'));
    ddCat?.removeAttribute('data-selected');
    sizeBtns.forEach(x => x.classList.remove('active'));
    colorBtns.forEach(x => x.classList.remove('active'));
    if (rMin && rMax && iMin && iMax) {
      rMin.value = rMin.min; rMax.value = rMax.max;
      iMin.value = rMin.value; iMax.value = rMax.value;
      wrap && (wrap.style.background = '');
    }
    updateBadges();
    location.search = '';
  });

  $$('.dd-option[data-sort]').forEach(btn => {
    btn.addEventListener('click', () => {
      const v = btn.dataset.sort === 'asc' ? 'price_asc' : 'price_desc';
      applyFilters({order: v});
    });
  });

  // ===== Проставляем активное избранное при загрузке
  $$('.p-card').forEach(card => {
    const pid = Number(card.dataset.pid);
    const btn = card.querySelector('.p-flag-btn');
    if (!btn) return;
    const on = favSet.has(pid);
    btn.classList.toggle('active', on);
    btn.setAttribute('aria-pressed', on ? 'true' : 'false');
  });

  // ===== Quick View (с твоим fetch), плюс синк закладки
  const qv         = $('#qv');
  const qvPhoto    = $('#qvPhoto');
  const qvTitle    = $('#qvTitle');
  const qvPrice    = $('#qvPrice');
  const qvArt      = $('#qvArt');
  const qvBookmark = $('#qvBookmark');
  const qvColors   = $('#qvColors');
  const qvSizes    = $('#qvSizes');
  const qvFabrics  = $('#qvFabrics');
  let currentCard = null;

  function closeQuickView() {
    qv?.classList.remove('open');
    document.body.style.overflow = '';
    currentCard = null;
  }

  document.addEventListener('click', (e) => {
    const eye = e.target.closest('.p-eye-btn');
    if (!eye) return;
    e.preventDefault(); e.stopPropagation();
    const card = eye.closest('.p-card');
    if (!card) return;
    currentCard = card;

    qvTitle.textContent = 'Загрузка...';
    qvPrice.textContent = '';
    qvArt.textContent = '';
    qvPhoto.style.background = '#e2e2e2';
    qvColors.innerHTML = '';
    qvSizes.innerHTML = '';
    qvFabrics.innerHTML = '';

    const pid = card.getAttribute('data-pid');
    const qvUrl = "{% url 'product_quick_view' 0 %}".replace('/0/', `/${pid}/`);

    fetch(qvUrl)
      .then(r => r.ok ? r.json() : Promise.reject(r))
      .then(data => {
        qvTitle.textContent = data.name;
        qvPrice.textContent = `${fmt.format(data.price)} ₽`;
        qvArt.textContent = `АРТ. ${data.article}`;
        qvPhoto.style.background = data.image
          ? `url('${data.image}') center/cover no-repeat` : '#e2e2e2';
        (data.colors || []).forEach(c => {
          const b = document.createElement('span');
          b.className = 'dot'; b.title = c.name;
          b.style.cssText = 'display:inline-block;width:18px;height:18px;border-radius:50%;vertical-align:middle;border:1px solid #ccc;';
          b.style.background = c.hex || '#000';
          qvColors.appendChild(b);
        });
        (data.sizes || []).forEach(s => {
          const b = document.createElement('span');
          b.className = 'sz'; b.textContent = s.name || s;
          qvSizes.appendChild(b);
        });
        (data.fabrics || []).forEach(f => {
          const span = document.createElement('span');
          span.textContent = `${f.name} ${f.pct}%`;
          span.style.cssText = 'margin-right:8px;';
          qvFabrics.appendChild(span);
        });
      })
      .catch(() => {
        qvTitle.textContent = 'Ошибка загрузки';
        qvPhoto.style.background = '#f5c2c7';
      });

    // синк иконки
    const pidNum = Number(pid);
    const on = favSet.has(pidNum);
    qvBookmark?.classList.toggle('active', on);
    qvBookmark?.setAttribute('aria-pressed', on ? 'true' : 'false');

    qv?.classList.add('open');
    document.body.style.overflow = 'hidden';
  });

  qv?.addEventListener('click', e => { if (e.target.hasAttribute('data-qv-close')) closeQuickView(); });
  document.addEventListener('keydown', e => { if (e.key === 'Escape' && qv?.classList.contains('open')) closeQuickView(); });

  // ===== Тоггл избранного из модалки (с сервером)
  qvBookmark?.addEventListener('click', async e => {
    e.preventDefault();
    if (!currentCard) return;
    const pid = Number(currentCard.dataset.pid);
    try{
      const data = await toggleFavorite(pid);
      const on = !!data.on;
      qvBookmark.classList.toggle('active', on);
      qvBookmark.setAttribute('aria-pressed', on ? 'true' : 'false');

      const flag = currentCard.querySelector('.p-flag-btn');
      if (flag){ flag.classList.toggle('active', on); flag.setAttribute('aria-pressed', on ? 'true' : 'false'); }
      if (on) favSet.add(pid); else favSet.delete(pid);
    }catch(e){ console.error(e); }
  });

  // ===== Тоггл избранного с карточки (с сервером)
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.p-flag-btn');
    if (!btn) return;
    e.preventDefault(); e.stopPropagation();
    const card = btn.closest('.p-card');
    const pid = Number(card?.dataset.pid);
    try{
      const data = await toggleFavorite(pid);
      const on = !!data.on;
      btn.classList.toggle('active', on);
      btn.setAttribute('aria-pressed', on ? 'true' : 'false');

      if (qv?.classList.contains('open') && currentCard === card){
        qvBookmark.classList.toggle('active', on);
        qvBookmark.setAttribute('aria-pressed', on ? 'true' : 'false');
      }
      if (on) favSet.add(pid); else favSet.delete(pid);
    }catch(err){ console.error(err); }
  });

})();</script>




{% endblock content %}