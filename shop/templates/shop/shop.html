{% extends "_base.html" %}
{% load static %}

{% block title %}Магазин{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'css/shop.css' %}">
{% endblock %}

{% block content %}
    <div class="status-bar" role="navigation" aria-label="Статус-бар">
        <div class="sb-inner">
            <img class="sb-logo" src="{% static 'images/GY.svg' %}" alt="GY">
            <span class="sb-dot" aria-hidden="true"></span>
            <a class="sb-link" href="{% url 'shop' %}">МАГАЗИН</a>
        </div>
    </div>


    <main>

        <div class="serch-container">
            <h2 class="shop-title">МАГАЗИН</h2>

            <form class="shop-search" role="search" method="get">
                <button class="shop-search-btn" aria-label="Поиск">
                    <img src="{% static 'icons/search.svg' %}" alt="">
                </button>
                <input class="shop-search-input" type="search" name="q" value="{{ q }}" placeholder="Поиск по товарам">
            </form>
        </div>


        <!-- FILTERS BAR -->
        <div class="filters-bar" role="region" aria-label="Фильтры каталога">
            <div class="fb-top">
                <button class="fb-menu" aria-label="Открыть панель фильтров">
                    <svg width="38" height="38" viewBox="0 0 18 18" aria-hidden="true" focusable="false">
                        <rect width="18" height="18" rx="1" fill="#111" />
                        <path d="M3 5.5H15" stroke="#fff" stroke-width="1.2" stroke-linecap="round" />
                        <path d="M5 9H13" stroke="#fff" stroke-width="1.2" stroke-linecap="round" />
                        <path d="M6.5 12.5H11.5" stroke="#fff" stroke-width="1.2" stroke-linecap="round" />
                    </svg>


                </button>
            </div>

            <div class="fb-row">
                <div class="fb-dd" data-dd="category">
                    <button class="fb-item" type="button">КАТЕГОРИЯ ТОВАРА
                        <svg class="chev" width="10" height="16" viewBox="0 0 8 12">
                            <path d="M1 1 L7 6 L1 11" fill="none" stroke="currentColor" stroke-width="1.4"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </button>
                        <div class="fb-popover w260">
                            <ul class="dd-list">
                                {% for cat in categories %}
                                <li>
                                    <button type="button" class="dd-category"
                                            data-category="{{ cat.id }}"
                                            {% if selected.category|add:'' == cat.id|add:'' %}aria-current="true"{% endif %}>
                                    {{ cat.name }}
                                    </button>
                                </li>
                                {% endfor %}
                                <li class="dd-all"><button type="button" class="dd-category-clear">Показать все</button></li>
                            </ul>
                        </div>
                </div>

                <!-- РАЗМЕР -->
                <div class="fb-dd" data-dd="size">
                    <button class="fb-item" type="button">РАЗМЕР ОДЕЖДЫ
                        <svg class="chev" width="10" height="16" viewBox="0 0 8 12">
                            <path d="M1 1 L7 6 L1 11" fill="none" stroke="currentColor" stroke-width="1.4"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </button>
                    <div class="fb-popover w220">
                        <div class="dd-sizes">
                            {% for sz in sizes %}
                                <button class="sz" data-size="{{ sz.id }}">{{ sz.name }}</button>
                            {% endfor %}
                        </div>
                        <a href="#" class="dd-link muted">РАЗМЕРНАЯ СЕТКА</a>
                    </div>
                </div>

                <!-- ЦЕНА -->
                <div class="fb-dd" data-dd="price">
                    <button class="fb-item" type="button">ЦЕНА
                        <svg class="chev" width="10" height="16" viewBox="0 0 8 12">
                            <path d="M1 1 L7 6 L1 11" fill="none" stroke="currentColor" stroke-width="1.4"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </button>
                    <div class="fb-popover w320">
                        <div class="dd-price">
                            <div class="row">
                                <input type="number" class="price-min" value="0" min="0" max="100000" step="100">
                                <input type="number" class="price-max" value="100000" min="0" max="100000" step="100">
                            </div>
                            <div class="range-wrap" data-min="0" data-max="100000">
                                <input type="range" class="range-min" min="0" max="100000" value="0" step="100">
                                <input type="range" class="range-max" min="0" max="100000" value="100000" step="100">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ЦВЕТ -->
                <div class="fb-dd" data-dd="color">
                    <button class="fb-item" type="button">ЦВЕТ
                        <svg class="chev" width="10" height="16" viewBox="0 0 8 12">
                            <path d="M1 1 L7 6 L1 11" fill="none" stroke="currentColor" stroke-width="1.4"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </button>
                    <div class="fb-popover w160">
                        <div class="dd-colors">
                            {% for clr in colors %}
                                <button class="dot" style="--c:{{ clr.hex_code }}" title="{{ clr.name }}" data-color="{{ clr.id }}"></button>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                </nav>

                <div class="fb-sort">
                    <div class="fb-dd" data-dd="sort">
                        <button class="fb-item fb-sortby" type="button">ПО СТОИМОСТИ
                            <svg class="chev" width="10" height="16" viewBox="0 0 8 12">
                                <path d="M1 1 L7 6 L1 11" fill="none" stroke="currentColor" stroke-width="1.4"
                                    stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </button>
                        <div class="fb-popover w260">
                            <ul class="dd-list">
                                <li><button class="dd-option" data-sort="asc">Цена по возрастанию</button></li>
                                <li><button class="dd-option" data-sort="desc">Цена по убыванию</button></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <script>
                (() => {
                    const dds = document.querySelectorAll('.fb-dd');

                    // открыть/закрыть поповеры
                    dds.forEach(dd => {
                        const btn = dd.querySelector('.fb-item');
                        btn?.addEventListener('click', e => {
                            e.stopPropagation();
                            const opened = dd.classList.contains('open');
                            dds.forEach(x => x.classList.remove('open'));
                            if (!opened) dd.classList.add('open');
                        });
                    });
                    document.addEventListener('click', () => dds.forEach(x => x.classList.remove('open')));
                    document.addEventListener('keydown', e => { if (e.key === 'Escape') dds.forEach(x => x.classList.remove('open')); });

                    const ddCat = document.querySelector('.fb-dd[data-dd="category"]');
                    const ddSize = document.querySelector('.fb-dd[data-dd="size"]');
                    const ddColor = document.querySelector('.fb-dd[data-dd="color"]');
                    const ddPrice = document.querySelector('.fb-dd[data-dd="price"]');

                    const setActive = (dd, on) => dd?.querySelector('.fb-item')?.classList.toggle('is-active', !!on);
                    const any = (root, sel) => !!(root && root.querySelector(sel));

                    // выбор цвета
                    // document.querySelectorAll('.dd-colors .dot').forEach(dot => {
                    //     dot.addEventListener('click', () => {
                    //         dot.classList.toggle('active');
                    //         updateActives();
                    //     });
                    // });

                    // // выбор размера
                    // document.querySelectorAll('.dd-sizes .sz').forEach(sz => {
                    //     sz.addEventListener('click', () => {
                    //         sz.classList.toggle('active');
                    //         updateActives();
                    //     });
                    // });

                    // // выбор категории (пока заглушки-ссылки)
                    // ddCat?.querySelectorAll('.dd-list li:not(.dd-all) a').forEach(a => {
                    //     a.addEventListener('click', e => {
                    //         e.preventDefault();
                    //         ddCat.dataset.selected = '1';
                    //         updateActives();
                    //     });
                    // });


                    ddCat?.querySelector('.dd-all a')?.addEventListener('click', e => {
                        e.preventDefault();
                        delete ddCat.dataset.selected;
                        updateActives();
                    });

                    // цена: двойной ползунок
                    let rMin, rMax, iMin, iMax, wrap;
                    const minGap = 100;
                    if (ddPrice) {
                        wrap = ddPrice.querySelector('.range-wrap');
                        rMin = ddPrice.querySelector('.range-min');
                        rMax = ddPrice.querySelector('.range-max');
                        iMin = ddPrice.querySelector('.price-min');
                        iMax = ddPrice.querySelector('.price-max');

                        function paint() {
                            const min = +rMin.min, max = +rMax.max;
                            const a = ((+rMin.value - min) / (max - min)) * 100;
                            const b = ((+rMax.value - min) / (max - min)) * 100;
                            wrap.style.background = `linear-gradient(to right,#ddd ${a}%, #111 ${a}%, #111 ${b}%, #ddd ${b}%)`;
                        }
                        function clampFromRange(changed) {
                            let a = +rMin.value, b = +rMax.value;
                            if (b - a < minGap) {
                                if (changed === rMin) a = b - minGap; else b = a + minGap;
                                rMin.value = a; rMax.value = b;
                            }
                            iMin.value = rMin.value; iMax.value = rMax.value;
                            paint(); updateActives();
                        }
                        function clampFromInput() {
                            let a = Math.max(+iMin.min || 0, +iMin.value || 0);
                            let b = Math.min(+iMax.max || 100000, +iMax.value || 0);
                            if (b - a < minGap) b = a + minGap;
                            rMin.value = a; rMax.value = b; iMin.value = a; iMax.value = b;
                            paint(); updateActives();
                        }
                        rMin.addEventListener('input', () => clampFromRange(rMin));
                        rMax.addEventListener('input', () => clampFromRange(rMax));
                        iMin.addEventListener('change', clampFromInput);
                        iMax.addEventListener('change', clampFromInput);
                        paint();
                    }

                    // сброс всех фильтров
                    document.querySelector('.fb-clear')?.addEventListener('click', () => {
                        delete ddCat?.dataset.selected;
                        ddSize?.querySelectorAll('.sz.active').forEach(x => x.classList.remove('active'));
                        ddColor?.querySelectorAll('.dot.active').forEach(x => x.classList.remove('active'));
                        if (ddPrice) {
                            rMin.value = rMin.min; rMax.value = rMax.max;
                            iMin.value = rMin.value; iMax.value = rMax.value;
                            wrap && (wrap.style.background = '');
                        }
                        updateActives();
                    });

                    function updateActives() {
                        setActive(ddCat, ddCat?.dataset.selected === '1');
                        setActive(ddSize, any(ddSize, '.sz.active'));
                        setActive(ddColor, any(ddColor, '.dot.active'));
                        if (ddPrice) {
                            const active = (+rMin.value > +rMin.min) || (+rMax.value < +rMax.max);
                            setActive(ddPrice, active);
                        }
                    }

                    updateActives(); // стартовое состояние
                })();
            </script>



            <script>
                (() => {
                    const bar = document.querySelector('.filters-bar');
                    const btn = bar?.querySelector('.fb-menu');
                    const row = bar?.querySelector('.fb-row');
                    if (!bar || !btn || !row) return;

                    // закрываем поповеры при сворачивании
                    const closePopovers = () => bar.querySelectorAll('.fb-dd.open').forEach(x => x.classList.remove('open'));

                    const collapse = () => {
                        closePopovers();
                        const h = row.scrollHeight;
                        row.style.height = h + 'px';
                        bar.classList.add('is-collapsing');
                        requestAnimationFrame(() => {
                            row.style.opacity = '0';
                            row.style.height = '0px';
                        });
                        row.addEventListener('transitionend', function onEnd(e) {
                            if (e.propertyName !== 'height') return;
                            row.removeEventListener('transitionend', onEnd);
                            row.style.display = 'none';
                            row.style.height = '';
                            bar.classList.remove('is-collapsing');
                            bar.classList.add('is-collapsed');
                            btn.setAttribute('aria-expanded', 'false');
                        });
                    };

                    const expand = () => {
                        row.style.display = '';
                        // сразу ставим 0, затем плавно до фактической высоты
                        row.style.opacity = '0';
                        row.style.height = '0px';
                        const h = row.scrollHeight;
                        bar.classList.add('is-expanding');
                        requestAnimationFrame(() => {
                            row.style.opacity = '1';
                            row.style.height = h + 'px';
                        });
                        row.addEventListener('transitionend', function onEnd(e) {
                            if (e.propertyName !== 'height') return;
                            row.removeEventListener('transitionend', onEnd);
                            row.style.height = '';
                            bar.classList.remove('is-expanding');
                            bar.classList.remove('is-collapsed');
                            btn.setAttribute('aria-expanded', 'true');
                        });
                    };

                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (bar.classList.contains('is-collapsed')) expand(); else collapse();
                    });

                    // при ресайзе правим авто-высоту, если блок открыт
                    window.addEventListener('resize', () => {
                        if (!bar.classList.contains('is-collapsed') && row.style.height) {
                            row.style.height = row.scrollHeight + 'px';
                        }
                    });
                })();
            </script>



        </div>





        <section class="catalog">

            <div class="catalog-grid">
                {% for p in items %}
                    <a class="p-card" href="{% url 'product_detail' p.pk %}" data-pid="{{ p.id }}">
                        <div class="p-media" aria-label="Изображение товара">
                            <button class="p-flag-btn" type="button" aria-label="В избранное" aria-pressed="false">
                                <svg width="30" height="35" viewBox="0 0 18 22" aria-hidden="true">
                                    <path d="M3 2.5H15a1 1 0 0 1 1 1V20.5L9 16.5l-7 4V3.5a1 1 0 0 1 1-1Z" fill="none"
                                        stroke="#fff" stroke-width="2" stroke-linejoin="round" />
                                </svg>
                            </button>
                            <button class="p-eye-btn" type="button" aria-label="Быстрый просмотр">
                                <img src="{% static 'icons/eye.svg' %}" alt="" width="18" height="18">
                            </button>
                            {% if p.thumb_id %}
                                {% for im in p.images.all %}
                                    {% if im.id == p.thumb_id %}
                                        <img src="{{ im.image.url }}" alt="{{ p.name }}">
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                <img src="{% static 'images/no-photo.png' %}" alt="Нет фото">
                            {% endif %}
                        </div>
                        <div class="p-info">
                            <div class="p-title">{{ p.name }}</div>
                            <div class="p-meta">
                                <span class="p-price">{{ p.formatted_price }} ₽</span>
                                <span class="p-art">АРТ. {{ p.article }}</span>
                            </div>
                        </div>
                    </a>
                {% empty %}
                    <p>Нет товаров</p>
                {% endfor %}
            </div>

        </section>

        <!-- PAGINATION -->
        {% if is_paginated %}
        <nav class="pager" role="navigation" aria-label="Пагинация">
            {% if page_obj.has_previous %}
                <a class="pg-btn pg-prev" href="?page={{ page_obj.previous_page_number }}">&laquo;</a>
            {% endif %}

            <ul class="pg-list">
                {% for num in paginator.page_range %}
                    {% if num == page_obj.number %}
                        <li><span class="pg-link is-current">{{ num }}</span></li>
                    {% else %}
                        <li><a class="pg-link" href="?page={{ num }}">{{ num }}</a></li>
                    {% endif %}
                {% endfor %}
            </ul>

            {% if page_obj.has_next %}
                <a class="pg-btn pg-next" href="?page={{ page_obj.next_page_number }}">&raquo;</a>
            {% endif %}
        </nav>
        {% endif %}




        <script>
            (() => {
                let qv, qvPhoto, qvTitle, qvPrice, qvArt, qvBookmark, currentCard = null;

                function cacheQv() {
                    if (qv) return;
                    qv = document.getElementById('qv');
                    qvPhoto = document.getElementById('qvPhoto');
                    qvTitle = document.getElementById('qvTitle');
                    qvPrice = document.getElementById('qvPrice');
                    qvArt = document.getElementById('qvArt');
                    qvBookmark = document.getElementById('qvBookmark');

                    qv?.addEventListener('click', e => { if (e.target.hasAttribute('data-qv-close')) closeQuickView(); });
                    qvBookmark?.addEventListener('click', (e) => {
                        e.preventDefault();
                        const on = !qvBookmark.classList.contains('active');
                        qvBookmark.classList.toggle('active', on);
                        qvBookmark.setAttribute('aria-pressed', on);
                        const flag = currentCard?.querySelector('.p-flag-btn');
                        if (flag) { flag.classList.toggle('active', on); flag.setAttribute('aria-pressed', on); }
                    });
                }

                function syncBookmarkFromCard(card) {
                    const flag = card?.querySelector('.p-flag-btn');
                    const on = !!flag && flag.classList.contains('active');
                    qvBookmark?.classList.toggle('active', on);
                    qvBookmark?.setAttribute('aria-pressed', on);
                }

                function openQuickView(card) {
                    cacheQv();
                    currentCard = card;
                    const title = card.querySelector('.p-title')?.textContent?.trim() || 'Товар';
                    const price = card.querySelector('.p-price')?.innerHTML || '';
                    const art = card.querySelector('.p-art')?.textContent?.trim() || '';
                    const img = card.dataset.img || card.querySelector('.p-media img')?.getAttribute('src');

                    qvTitle.textContent = title;
                    qvPrice.innerHTML = price;
                    qvArt.textContent = art;
                    qvPhoto.style.background = img ? `url('${img}') center/cover no-repeat` : '#e2e2e2';

                    syncBookmarkFromCard(card);

                    qv.classList.add('open');
                    document.body.style.overflow = 'hidden';
                }
                function closeQuickView() {
                    qv?.classList.remove('open');
                    document.body.style.overflow = '';
                    currentCard = null;
                }

                document.addEventListener('click', (e) => {
                    const eye = e.target.closest('.p-eye-btn');
                    if (!eye) return;
                    e.preventDefault(); e.stopPropagation();
                    const card = eye.closest('.p-card');
                    openQuickView(card);
                });

                document.addEventListener('click', (e) => {
                    const flag = e.target.closest('.p-flag-btn');
                    if (!flag) return;
                    e.preventDefault(); e.stopPropagation();
                    const on = !flag.classList.contains('active');
                    flag.classList.toggle('active', on);
                    flag.setAttribute('aria-pressed', on);
                    if (currentCard && flag.closest('.p-card') === currentCard) {
                        cacheQv();
                        qvBookmark.classList.toggle('active', on);
                        qvBookmark.setAttribute('aria-pressed', on);
                    }
                });

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && qv?.classList.contains('open')) closeQuickView();
                });
            })();
        </script>







        <!-- MODAL QUICK VIEW MODAL -->
        <div class="qv" id="qv" aria-hidden="true">
            <div class="qv-overlay" data-qv-close></div>

            <div class="qv-panel" role="dialog" aria-modal="true" aria-label="Быстрый просмотр">
                <button class="qv-x" type="button" aria-label="Закрыть" data-qv-close>×</button>

                <div class="qv-left">
                    <div class="qv-photo" id="qvPhoto" role="img" aria-label="Фото товара"></div>
                </div>

                <div class="qv-right">
                    <div class="qv-top">
                        <h3 class="qv-title" id="qvTitle"></h3>
                        <button class="qv-bookmark" type="button" aria-label="В избранное" id="qvBookmark"
                            aria-pressed="false">
                            <svg width="22" height="26" viewBox="0 0 18 22" aria-hidden="true" focusable="false">
                                <path d="M3 2.5H15a1 1 0 0 1 1 1V20.5L9 16.5l-7 4V3.5a1 1 0 0 1 1-1Z" fill="none"
                                    stroke="#111" stroke-width="2" stroke-linejoin="round" />
                            </svg>
                        </button>
                    </div>

                    <div class="qv-price" id="qvPrice"></div>
                    <div class="qv-art" id="qvArt"></div>

                    <div class="qv-opts">
                        <div class="qv-row"><span class="qv-label">Цвета:</span> <div id="qvColors" class="qv-colors"></div></div>
                        <div class="qv-row"><span class="qv-label">Размеры:</span> <div id="qvSizes" class="qv-sizes"></div></div>
                        <div class="qv-row"><span class="qv-label">Состав:</span> <div id="qvFabrics" class="qv-fabrics"></div></div>
                    </div>

                </div>
            </div>
        </div>


    </main>




<script>
(() => {
  const fmt = new Intl.NumberFormat('ru-RU');

  let qv, qvPhoto, qvTitle, qvPrice, qvArt, qvBookmark, qvColors, qvSizes, qvFabrics, currentCard = null;
  function cacheQv() {
    if (qv) return;
    qv = document.getElementById('qv');
    qvPhoto = document.getElementById('qvPhoto');
    qvTitle = document.getElementById('qvTitle');
    qvPrice = document.getElementById('qvPrice');
    qvArt   = document.getElementById('qvArt');
    qvBookmark = document.getElementById('qvBookmark');
    qvColors = document.getElementById('qvColors');
    qvSizes  = document.getElementById('qvSizes');
    qvFabrics= document.getElementById('qvFabrics');

    qv?.addEventListener('click', e => { if (e.target.hasAttribute('data-qv-close')) closeQuickView(); });
  }

  function fillList(el, items, render) {
    el.innerHTML = '';
    if (!items || !items.length) { el.textContent = '—'; return; }
    const frag = document.createDocumentFragment();
    items.forEach(x => frag.appendChild(render(x)));
    el.appendChild(frag);
  }

  function openQuickView(card) {
    cacheQv();
    currentCard = card;

    // прелоадер/скелетон
    qvTitle.textContent = 'Загрузка...';
    qvPrice.textContent = '';
    qvArt.textContent = '';
    qvPhoto.style.background = '#e2e2e2';
    qvColors.innerHTML = '';
    qvSizes.innerHTML = '';
    qvFabrics.innerHTML = '';

    const pid = card.getAttribute('data-pid');
    const qvUrl = "{% url 'product_quick_view' 0 %}".replace('/0/', `/${pid}/`);

    fetch(qvUrl)
      .then(r => r.ok ? r.json() : Promise.reject(r))
      .then(data => {
        qvTitle.textContent = data.name;
        qvPrice.textContent = `${fmt.format(data.price)} ₽`;
        qvArt.textContent = `АРТ. ${data.article}`;
        qvPhoto.style.background = data.image
          ? `url('${data.image}') center/cover no-repeat`
          : '#e2e2e2';

        fillList(qvColors, data.colors, (c) => {
          const b = document.createElement('span');
          b.className = 'dot';
          b.title = c.name;
          b.style.cssText = `display:inline-block;width:18px;height:18px;border-radius:50%;margin:2px;vertical-align:middle;background:${c.hex};border:1px solid #ccc;`;
          return b;
        });

        fillList(qvSizes, data.sizes, (s) => {
          const b = document.createElement('span');
          b.className = 'sz';
          b.textContent = s.name;
          b.style.cssText = 'display:inline-block;border:1px solid #ccc;border-radius:4px;padding:2px 6px;margin:2px;font-size:12px;';
          return b;
        });

        fillList(qvFabrics, data.fabrics, (f) => {
          const span = document.createElement('span');
          span.textContent = `${f.name} ${f.pct}%`;
          span.style.cssText = 'margin-right:8px;';
          return span;
        });
      })
      .catch(() => {
        qvTitle.textContent = 'Ошибка загрузки';
        qvPhoto.style.background = '#f5c2c7';
      });

    qv.classList.add('open');
    document.body.style.overflow = 'hidden';
  }

  function closeQuickView() {
    qv?.classList.remove('open');
    document.body.style.overflow = '';
    currentCard = null;
  }

  // клики на глазике карточки
  document.addEventListener('click', (e) => {
    const eye = e.target.closest('.p-eye-btn');
    if (!eye) return;
    e.preventDefault(); e.stopPropagation();
    const card = eye.closest('.p-card');
    if (!card) return;
    openQuickView(card);
  });

  // ESC чтобы закрыть
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && qv?.classList.contains('open')) closeQuickView();
  });
})();
</script>





<script>
document.addEventListener('DOMContentLoaded', () => {
  const $  = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

  // элементы
  const formSearch = $('.shop-search');
  const inputSearch = $('.shop-search-input');

  const ddCat = $('.fb-dd[data-dd="category"]');
  const btnCats = $$('.dd-category');           // если делаешь <button class="dd-category" data-category="id">
  const btnCatClear = $('.dd-category-clear');  // если есть кнопка "Показать все"

  const colorBtns = $$('.dd-colors .dot');      // <button class="dot" data-color="id">
  const sizeBtns  = $$('.dd-sizes .sz');        // <button class="sz" data-size="id">

  const wrap = $('.fb-dd[data-dd="price"] .range-wrap');
  const rMin = $('.range-min'), rMax = $('.range-max');
  const iMin = $('.price-min'), iMax = $('.price-max');

  // дефолты цены из data-атрибутов
  const DEF_MIN = wrap ? +wrap.dataset.min || 0 : 0;
  const DEF_MAX = wrap ? +wrap.dataset.max || 0 : 0;

  // Инициализация UI из текущего URL
  const url = new URL(window.location.href);
  const params = url.searchParams;

  // поиск
  if (inputSearch) inputSearch.value = params.get('q') || '';

  // категория
  const curCat = params.get('category');
  if (curCat && ddCat) ddCat.dataset.selected = '1';
  btnCats.forEach(b => {
    if (b.dataset.category === curCat) b.setAttribute('aria-current','true');
  });

  // цвета
  const curColors = params.getAll('color');
  colorBtns.forEach(b => {
    if (curColors.includes(b.dataset.color)) b.classList.add('active');
  });

  // размеры
  const curSizes = params.getAll('size');
  sizeBtns.forEach(b => {
    if (curSizes.includes(b.dataset.size)) b.classList.add('active');
  });

  // цена
  const curMin = params.get('price_min');
  const curMax = params.get('price_max');
  if (rMin && rMax && iMin && iMax) {
    rMin.value = iMin.value = curMin ?? DEF_MIN;
    rMax.value = iMax.value = curMax ?? DEF_MAX;
  }

  // helper: собрать параметры из UI и перейти
  function applyFilters(extra={}) {
    const p = new URLSearchParams();

    // поиск
    const q = inputSearch?.value.trim();
    if (q) p.set('q', q);

    // категория
    const chosenCat = $('.dd-category[aria-current="true"]')?.dataset.category;
    if (chosenCat) p.set('category', chosenCat);

    // размеры
    $$('.dd-sizes .sz.active').forEach(b => p.append('size', b.dataset.size));

    // цвета
    $$('.dd-colors .dot.active').forEach(b => p.append('color', b.dataset.color));

    // цена — ТОЛЬКО если отличается от дефолта
    if (rMin && rMax && iMin && iMax) {
      const vMin = +iMin.value || DEF_MIN;
      const vMax = +iMax.value || DEF_MAX;
      if (vMin !== DEF_MIN) p.set('price_min', String(vMin));
      if (vMax !== DEF_MAX) p.set('price_max', String(vMax));
    }

    // сортировка
    const order = extra.order || params.get('order') || 'new';
    if (order) p.set('order', order);

    // сбрасываем пагинацию
    p.delete('page');

    // доп. ключи
    for (const [k,v] of Object.entries(extra)) {
      if (v === null) p.delete(k); else p.set(k, v);
    }

    const qs = p.toString();
    window.location.search = qs ? `?${qs}` : '';
  }

  // обработчики

  // поиск
  formSearch?.addEventListener('submit', e => { e.preventDefault(); applyFilters(); });

// категория
btnCats.forEach(b => {
  b.addEventListener('click', e => {
    e.preventDefault();
    e.stopImmediatePropagation();
    document.querySelectorAll('.dd-category[aria-current="true"]').forEach(x => x.removeAttribute('aria-current'));
    b.setAttribute('aria-current', 'true');
    ddCat?.setAttribute('data-selected','1');
    applyFilters();
  });
});
btnCatClear?.addEventListener('click', e => {
  e.preventDefault();
  e.stopImmediatePropagation();
  document.querySelectorAll('.dd-category[aria-current="true"]').forEach(x => x.removeAttribute('aria-current'));
  ddCat?.removeAttribute('data-selected');
  applyFilters();
});

// цвета/размеры
colorBtns.forEach(b => b.addEventListener('click', e => {
  e.preventDefault();
  e.stopImmediatePropagation();
  b.classList.toggle('active');
  applyFilters();
}));
sizeBtns.forEach(b => b.addEventListener('click', e => {
  e.preventDefault();
  e.stopImmediatePropagation();
  b.classList.toggle('active');
  applyFilters();
}));

// цена
rMin?.addEventListener('change', e => { e.stopImmediatePropagation(); iMin.value = rMin.value; applyFilters(); });
rMax?.addEventListener('change', e => { e.stopImmediatePropagation(); iMax.value = rMax.value; applyFilters(); });
iMin?.addEventListener('blur',  e => { e.stopImmediatePropagation(); rMin.value = iMin.value || DEF_MIN; applyFilters(); });
iMax?.addEventListener('blur',  e => { e.stopImmediatePropagation(); rMax.value = iMax.value || DEF_MAX; applyFilters(); });


  // сортировка (твои кнопки)
  $$('.dd-option[data-sort]').forEach(btn => {
    btn.addEventListener('click', () => {
      const v = btn.dataset.sort === 'asc' ? 'price_asc' : 'price_desc';
      applyFilters({order: v});
    });
  });

});
</script>




{% endblock content %}