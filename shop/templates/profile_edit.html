{% extends '_base.html' %}
{% load static %}

{% block title %}ПРОФИЛЬ{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'css/lk.css' %}">
{% endblock %}


{% block content %}

    <div class="status-bar" role="navigation" aria-label="Статус-бар">
        <div class="sb-inner">
            <img class="sb-logo" src="static/images/GY.svg" alt="GY">
            <span class="sb-dot" aria-hidden="true"></span>
            <a class="sb-link" href="/shop/">ЛИЧНЫЙ КАБИНЕТ</a>
            <span class="sb-dot" aria-hidden="true"></span>
            <a class="sb-link" href="/shop/">ПРОФИЛЬ</a>
        </div>
    </div>

    <main>

        <div class="lk-section-name">
            <div class="left-side">
                <img src="static/icons/user.svg" alt="">
                <p>ПРОФИЛЬ</p>
            </div>

            <div class="right-side">
                <button class="profile-close" type="button" aria-label="Закрыть">×</button>
            </div>
        </div>


        <section class="profile">

            <form class="profile-form" action="#" method="post" novalidate>
                <label class="pf-row">
                    <span class="pf-label">ФИО:</span>
                    <input class="pf-field" name="fio" type="text" autocomplete="name" spellcheck="false"
                        placeholder="ИВАН ИВАНОВИЧ ИВАНОВ">
                </label>

                <label class="pf-row">
                    <span class="pf-label">Email:</span>
                    <input class="pf-field" name="email" type="email" autocomplete="email" placeholder="MAIL@MAIL.RU">
                </label>

                <label class="pf-row">
                    <span class="pf-label">Телефон:</span>
                    <input class="pf-field" name="phone" type="tel" inputmode="tel" autocomplete="tel"
                        placeholder="+7 XXX XXX XX XX" maxlength="18">
                </label>

                <label class="pf-row">
                    <span class="pf-label">Постоянный адрес доставки:</span>
                    <textarea class="pf-field pf-area" name="address" rows="3" placeholder="Г. МОСКВА, …"></textarea>
                </label>

                <label class="pf-row">
                    <span class="pf-label">Карта:</span>
                    <input class="pf-field" name="card" type="text" inputmode="numeric" autocomplete="cc-number"
                        maxlength="19" placeholder="XXXX XXXX XXXX XXXX">
                </label>

                <button class="pf-submit" type="submit">СОХРАНИТЬ ИЗМЕНЕНИЯ</button>
            </form>
        </section>



        <script>
            (() => {
                const f = document.querySelector('.profile-form');
                const fio = f.querySelector('input[name="fio"]');
                const email = f.querySelector('input[name="email"]');
                const card = f.querySelector('input[name="card"]');

                // Имя: только буквы (RU/EN), пробел и дефис
                fio.addEventListener('input', () => {
                    const clean = fio.value.replace(/[^A-Za-zА-Яа-яЁё \-]/g, '');
                    if (clean !== fio.value) fio.value = clean;
                    fio.classList.toggle('is-error', !!fio.value && !/^[A-Za-zА-Яа-яЁё \-]+$/.test(fio.value));
                });

                // Карта: только цифры + группировка по 4
                card.addEventListener('input', () => {
                    const digits = card.value.replace(/\D/g, '').slice(0, 16);
                    const parts = digits.match(/.{1,4}/g) || [];
                    card.value = parts.join(' ');
                    card.classList.toggle('is-error', digits.length && digits.length < 16);
                });

                // Email: подсветка красным, если невалиден
                const emailRe = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i;
                function checkEmail() {
                    const v = email.value.trim();
                    email.classList.toggle('is-error', v.length && !emailRe.test(v));
                }
                email.addEventListener('input', checkEmail);
                email.addEventListener('blur', checkEmail);

                // Пересчёт высоты, если поля растянулись
                window.addEventListener('resize', () => {
                    document.querySelectorAll('.acc.open .acc-panel').forEach(p => p.style.maxHeight = p.scrollHeight + 'px');
                });

                // Финальная проверка перед отправкой
                f.addEventListener('submit', (e) => {
                    const okFio = fio.value.trim().length && /^[A-Za-zА-Яа-яЁё \-]+$/.test(fio.value);
                    const okMail = email.value.trim().length && emailRe.test(email.value.trim());
                    const okCard = card.value.replace(/\D/g, '').length === 16;

                    if (!okFio) fio.classList.add('is-error');
                    if (!okMail) email.classList.add('is-error');
                    if (!okCard) card.classList.add('is-error');

                    if (!okFio || !okMail || !okCard) e.preventDefault();
                });

                const phone = f.querySelector('input[name="phone"]');

                phone.addEventListener('input', () => {
                    let d = phone.value.replace(/\D/g, '');      // оставляем только цифры
                    if (d.startsWith('8')) d = '7' + d.slice(1); // приводим 8 к 7
                    if (d && !d.startsWith('7')) d = '7' + d;    // всегда начинаем с 7
                    d = d.slice(0, 11);                           // максимум 11 цифр (+7 и ещё 10)

                    const rest = d.replace(/^7/, '');
                    let v = '+7';
                    if (rest.length > 0) v += ' ' + rest.slice(0, 3);
                    if (rest.length > 3) v += ' ' + rest.slice(3, 6);
                    if (rest.length > 6) v += ' ' + rest.slice(6, 8);
                    if (rest.length > 8) v += ' ' + rest.slice(8, 10);
                    phone.value = v;
                });
            })();
        </script>


    </main>


{% endblock content %}