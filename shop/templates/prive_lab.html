{% extends '_base.html' %}
{% load static %}
{% load site_settings %}
{% get_site_contacts as s %}

{% block title %}PRIVE Labaratory{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/prive_lab.css' %}" />
{% endblock %}


{% block content %}


<div class="status-bar" role="navigation" aria-label="Статус-бар">
    <div class="sb-inner">
        <a href="/">
            <img class="sb-logo" src="{% static 'images/GY.svg' %}" alt="GY">
        </a>
        <span class="sb-dot" aria-hidden="true"></span>
        <a class="sb-link" href="{% url 'prive-lab' %}">PRIVE Laboratory</a>
    </div>
</div>

<main>

    <section class="prive-hero">

        <div class="prive-hero-text">
            <h1 class="prive-title">PRIVE Laboratory</h1>
            <p class="prive-subtitle">of GABRIEL YUSUBOV</p>

            <div class="prive-intro">
                <p>Услуга премиального и индивидуального пошива под заказ.</p>
            </div>
        </div>

        <img src="{% static 'images/prive-hero.jpg' %}" alt="">

    </section>

    <section class="prive-hero-blackbar">
        <div class="prive-note">
            <p>
                Творчество моей линии Prive laboratory имеет свое начало в пошиве одежды по
                индивидуальным меркам.
                Со временем мы перейдем к изготовлению других предметов, которые будут участвовать в уточнении
                вашего комфортного образа.
            </p>
        </div>
    </section>

    <section class="prive-lab">

        <div class="prive-note-container">
            <div class="prive-note">
                <p class="right">
                    Все, что мы выпускаем в <strong>Prive laboratory</strong>, создается совместно с вами и с учетом
                    вашего видения.
                    <br><br>
                    Мы даем гарантию, что изготовленные <strong>изделия производятся в единственном экземпляре.</strong>
                    Повторное
                    воспроизведение вещи исключено, а также все заказы, полученные в рамках услуги индивидуального
                    пошива, не будут представлены в качестве моделей, доступных для приобретения в нашем магазине,
                    открытие которого вы также будете наблюдать в скором времени.
                </p>
            </div>
        </div>

        <div class="prive-steps-intro">
            <p>
                Индивидуальный пошив изделия на заказ — это комплексный процесс, требующий особого внимания <br>
                к деталям на каждом этапе. <br><br>
                Расскажем, как мы строим совместную работу с вами.
            </p>
        </div>
    </section>


    <section class="prive-accordion">

        <h2 class="prive-steps-title">ЭТАПЫ ВЗАИМОДЕЙСТВИЯ С КЛИЕНТОМ:</h2>

        <div class="acc open">
            <button class="acc-head" type="button">
                <span class="acc-title">СОГЛАСОВАНИЕ С КЛИЕНТОМ</span>
                <span class="acc-icon" aria-hidden="true"></span>
            </button>
            <div class="acc-panel">
                <p>На первом этапе дизайнер обсуждает с клиентом его пожелания: фасон, стиль, особенности фигуры и цель
                    изделия. Выбираются подходящие ткани и фурнитура.
                    На основе пожеланий клиента и предложений дизайнера создаётся эскиз. Это визуализация будущего
                    изделия, где учитываются его общий вид, силуэт и основные элементы. Эскиз позволяет представить,
                    каким будет конечный результат.</p>
            </div>
        </div>

        <div class="acc">
            <button class="acc-head" type="button">
                <span class="acc-title">СНЯТИЕ МЕРОК</span>
                <span class="acc-icon" aria-hidden="true"></span>
            </button>
            <div class="acc-panel">
                <p>Снятие точных мерок — важный этап, обеспечивающий идеальную посадку. Портной-закройщик учитывает все
                    параметры фигуры клиента, и другие нюансы, чтобы учесть все особенности клиента.</p>
            </div>
        </div>

        <div class="acc">
            <button class="acc-head" type="button">
                <span class="acc-title">ПРОМЕЖУТОЧНЫЕ ПРИМЕРКИ</span>
                <span class="acc-icon" aria-hidden="true"></span>
            </button>
            <div class="acc-panel">
                <p>Клиент приглашается на промежуточные примерки для корректировки изделия.
                    На первой примерке клиент надевает полуготовое изделие, и портной-закройщик вносит корректировки по
                    посадке и длине. Самая главная задача — добиться идеального соответствия фигуре.</p>
            </div>
        </div>

        <div class="acc">
            <button class="acc-head" type="button">
                <span class="acc-title">ФИНАЛЬНАЯ ПРИМЕРКА</span>
                <span class="acc-icon" aria-hidden="true"></span>
            </button>
            <div class="acc-panel">
                <p>На финальной примерке клиент проверяет готовое изделие. При необходимости вносятся последние правки,
                    после чего портной-закройщик завершает окончательную отделку.</p>
            </div>
        </div>

        <div class="acc">
            <button class="acc-head" type="button">
                <span class="acc-title">ПЕРЕДАЧА ИЗДЕЛИЯ ЗАКАЗЧИКУ</span>
                <span class="acc-icon" aria-hidden="true"></span>
            </button>
            <div class="acc-panel">
                <p>На этом этапе мы сообщаем клиенту о готовности изделия и договариваемся о способе получения изделия.
                </p>
            </div>
        </div>

        <div class="prive-sep" role="separator" aria-hidden="true"></div>

        <div class="acc">
            <button class="acc-head" type="button">
                <span class="acc-title">ОСТАВИТЬ ЗАЯВКУ</span>
                <span class="acc-icon" aria-hidden="true"></span>
            </button>

            <div class="acc-panel request">
                <form class="prive-form" id="reqForm">
                    {% csrf_token %}
                    <label>
                        <p>ФИО:</p>
                        <input type="text" name="full_name" required autocomplete="name">
                    </label>
                    <label>
                        <span>Email:</span>
                        <input type="email" name="email" placeholder="you@example.com">
                    </label>
                    <label>
                        <span>Телефон:</span>
                        <input type="tel"   name="phone" inputmode="tel" autocomplete="tel"
                            placeholder="+7 999 123 45 67" maxlength="18">
                    </label>

                    <input type="text" name="website" autocomplete="off" tabindex="-1" aria-hidden="true"
                        style="position:absolute;left:-5000px;width:1px;height:1px;opacity:0">
                    <input type="hidden" name="ts" value="{% now 'U' %}">

                    <button class="prive-submit" type="submit">Отправить</button>
                    <p class="req-msg" aria-live="polite" style="display:none;"></p>
                </form>
            </div>
        </div>

    </section>

</main>


<script>
    (() => {
        const form = document.getElementById('reqForm');
        const msg = form.querySelector('.req-msg');

        function show(t, ok = false) { msg.style.display = 'block'; msg.textContent = t; msg.style.color = ok ? '#2e7d32' : '#b00020'; }
        function setDisabled(on) { form.querySelector('.prive-submit').disabled = on; }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const fd = new FormData(form);
            const full_name = (fd.get('full_name') || fd.get('fio') || '').trim();
            const email = (fd.get('email') || '').trim();
            const phone = (fd.get('phone') || '').trim();
            const ts = form.querySelector('input[name=ts]')?.value || '';
            const website = form.querySelector('input[name=website]')?.value || '';

            if (!email && !phone) return show('Укажи телефон или email.');

            const csrf = form.querySelector('input[name=csrfmiddlewaretoken]')?.value || '';
            setDisabled(true);
            try {
                const r = await fetch("{% url 'reqs:submit' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrf
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ full_name, email, phone, ts, website })
                });

                const data = await r.json().catch(() => ({}));
                if (!r.ok || data.ok === false) {
                    const err = data.errors ? Object.values(data.errors).flat().join(' ') : 'Ошибка отправки.';
                    return show(err);
                }
                show('Заявка отправлена. Мы свяжемся с тобой!', true);
                form.reset();
            } catch {
                show('Сеть недоступна. Попробуй ещё раз.');
            } finally {
                setDisabled(false);
            }
        });
    })();
</script>

<script>
(() => {
  const form = document.getElementById('reqForm');
  const phone = form.querySelector('input[name=phone]');
  const fio   = form.querySelector('input[name=full_name]');
  const msg   = form.querySelector('.req-msg');

  const onlyDigits = (s) => (s || '').replace(/\D+/g, '');

  function formatRuPhone(raw) {
    let d = onlyDigits(raw);

    if (d.startsWith('8')) d = '7' + d.slice(1);
    if (!d.startsWith('7')) d = '7' + d;

    d = d.slice(0, 11);

    const p1 = d.slice(1, 4);
    const p2 = d.slice(4, 7);
    const p3 = d.slice(7, 9);
    const p4 = d.slice(9, 11);

    let out = '+7';
    if (p1) out += ' ' + p1;
    if (p2) out += ' ' + p2;
    if (p3) out += ' ' + p3;
    if (p4) out += ' ' + p4;
    return out;
  }

  function cleanRuE164(masked) {
    const d = onlyDigits(masked);
    if (d.length >= 11) return '+' + d.slice(0, 11);
    return '+' + d;
  }

  function applyPhoneMask(e) {
    const before = phone.value;
    const selStart = phone.selectionStart;

    if (e.type === 'keydown') {
      const k = e.key;
      const allowed = (
        k === 'Backspace' || k === 'Delete' || k === 'ArrowLeft' || k === 'ArrowRight' ||
        k === 'Home' || k === 'End' || k === 'Tab' || k === '+' || k === ' ' ||
        (k >= '0' && k <= '9')
      );
      if (!allowed) e.preventDefault();
      return;
    }

    const masked = formatRuPhone(before);
    phone.value = masked;

    phone.setSelectionRange(phone.value.length, phone.value.length);
  }

  phone.addEventListener('keydown', applyPhoneMask);
  phone.addEventListener('input',  applyPhoneMask);
  phone.addEventListener('paste',  (e) => setTimeout(applyPhoneMask, 0));

  function sanitizeFio(e) {
    fio.value = fio.value.replace(/[^\p{L}\s\-'’]/gu, '');
  }
  fio.addEventListener('input', sanitizeFio);

  function markInvalid(el, bad) {
    el.style.borderColor = bad ? '#b00020' : '';
  }

  const origSubmit = form.onsubmit;

  form.addEventListener('submit', (e) => {
    const email = (form.querySelector('input[name=email]').value || '').trim();
    const phoneMasked = (phone.value || '').trim();
    const phoneE164 = cleanRuE164(phoneMasked);
    const phoneOk = /^\+7\d{10}$/.test(phoneE164) || phoneMasked === '';

    const emailOk = email === '' || /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email);

    markInvalid(phone, !phoneOk);
    markInvalid(form.querySelector('input[name=email]'), !emailOk);

    if (!email && !phoneMasked) {
      msg.style.display='block'; msg.style.color='#b00020'; msg.textContent='Укажи телефон или email.';
      return;
    }
    if (!phoneOk) {
      msg.style.display='block'; msg.style.color='#b00020'; msg.textContent='Неверный телефон. Формат: +7 999 123 45 67';
      return;
    }
    if (!emailOk) {
      msg.style.display='block'; msg.style.color='#b00020'; msg.textContent='Неверный email.';
      return;
    }

    phone.value = phoneE164;
  }, true);
})();
</script>



<script>
    document.querySelectorAll('.prive-accordion .acc-head').forEach(btn => {
        btn.addEventListener('click', () => {
            const wrap = btn.closest('.acc');
            const panel = wrap.querySelector('.acc-panel');

            if (wrap.classList.contains('open')) {
                wrap.classList.remove('open');
                panel.style.maxHeight = null;
            } else {
                wrap.classList.add('open');
                panel.style.maxHeight = panel.scrollHeight + 'px';
            }
        });
    });
</script>

{% endblock content %}